name: CI/CD Pipeline ğŸš€

# KÃ­ch hoáº¡t workflow khi cÃ³ push hoáº·c pull request Ä‘áº¿n nhÃ¡nh dev
on:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # BÆ°á»›c 1: Checkout code tá»« repository
      - name: Checkout code ğŸ“
        uses: actions/checkout@v2

      # BÆ°á»›c 2: Thiáº¿t láº­p Docker Buildx
      - name: Set up Docker Buildx ğŸ› ï¸
        uses: docker/setup-buildx-action@v1

      # BÆ°á»›c 3: Cache Docker layers Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ build
      - name: Cache Docker layers âš¡
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

        # BÆ°á»›c 4: Cháº¡y npm ci Ä‘á»ƒ cÃ i Ä‘áº·t cÃ¡c phiÃªn báº£n phá»¥ thuá»™c chÃ­nh xÃ¡c
      - name: Install exact dependencies ğŸ“¦
        run: npm ci

      # BÆ°á»›c 5: Verify code quality and run tests ğŸ›¡ï¸
      - name: Verify code quality and run tests âœ…
        run: |
          # Kiá»ƒm tra cÃº phÃ¡p vá»›i ESLint
          npx eslint .
          # Cháº¡y cÃ¡c bÃ i kiá»ƒm thá»­ Ä‘Æ¡n vá»‹ vá»›i Jest
          npm test
      # BÆ°á»›c 6: Build Docker image ğŸ—ï¸
      - name: Build Docker image ğŸ› ï¸
        run: docker build --file Dockerfile --tag nextjs-app .

      # BÆ°á»›c 7: Run Docker Compose ğŸ³
      - name: Run Docker Compose ğŸš€
        run: docker-compose up -d
      # BÆ°á»›c 8: Run tests in the Docker container ğŸ”„
      - name: Run tests ğŸ§ª
        run: docker-compose exec app npm test
      # BÆ°á»›c 9: Initialize CodeQL ğŸ› ï¸
      - name: Initialize CodeQL ğŸ”
        uses: github/codeql-action/init@v1
        with:
          languages: javascript,typescript

      # BÆ°á»›c 10: Perform CodeQL Analysis ğŸ“ˆ
      - name: Perform CodeQL Analysis ğŸ•µï¸
        uses: github/codeql-action/analyze@v1
