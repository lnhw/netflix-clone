name: CI/CD Pipeline ğŸš€

# KÃ­ch hoáº¡t workflow khi cÃ³ push hoáº·c pull request Ä‘áº¿n nhÃ¡nh dev
on:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # BÆ°á»›c 1: Checkout code tá»« repository
      - name: Checkout code ğŸ“
        uses: actions/checkout@v2

      # BÆ°á»›c 2: Thiáº¿t láº­p Docker Buildx
      - name: Set up Docker Buildx ğŸ› ï¸
        uses: docker/setup-buildx-action@v1

      # BÆ°á»›c 3: Cache Docker layers Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ build
      - name: Cache Docker layers âš¡
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

        # BÆ°á»›c 4: Cháº¡y npm i  Ä‘á»ƒ cÃ i Ä‘áº·t
      - name: Install exact dependencies ğŸ“¦
        run: npm i --legacy-peer-deps

      # BÆ°á»›c 5: Verify code quality and run tests ğŸ›¡ï¸
      - name: Verify code quality and run tests âœ…
        run: |
          # Kiá»ƒm tra cÃº phÃ¡p vá»›i ESLint
          npx eslint .
      # BÆ°á»›c 6: Load .env.local file vÃ  thiáº¿t láº­p cÃ¡c biáº¿n mÃ´i trÆ°á»ng
      - name: Load .env.local file ğŸ“„
        run: |
          cp .env.local /tmp/.env.local  # Sao chÃ©p file .env.local vÃ o thÆ° má»¥c táº¡m
          set -a
          source /tmp/.env.local  # Náº¡p file .env.local tá»« thÆ° má»¥c táº¡m
          set +a

      # BÆ°á»›c 7: Build Docker image ğŸ—ï¸
      - name: Build Docker image ğŸ› ï¸
        run: |
          docker build \
            --file Dockerfile \
            --tag nextjs-app \
            --build-arg NEXT_PUBLIC_API_KEY=${NEXT_PUBLIC_API_KEY} \
            --build-arg NEXT_PUBLIC_TMDB_URL=${NEXT_PUBLIC_TMDB_URL} \
            --build-arg NEXT_PUBLIC_TMDB_URL_IMAGE=${NEXT_PUBLIC_TMDB_URL_IMAGE} \
            --build-arg NEXT_PUBLIC_URL=${NEXT_PUBLIC_URL} \
            --build-arg NEXTAUTH_SECRET=${NEXTAUTH_SECRET} \
            --build-arg GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} \
            --build-arg GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} \
            --build-arg GITHUB_ID=${GITHUB_ID} \
            --build-arg GITHUB_SECRET=${GITHUB_SECRET} \
            --build-arg NEXT_SHARP_PATH=${NEXT_SHARP_PATH}

      # BÆ°á»›c 8: Run Docker Compose ğŸ³
      - name: Run Docker Compose ğŸš€
        run: docker-compose up -d
        
      # BÆ°á»›c 9: Initialize CodeQL ğŸ”
      - name: Initialize CodeQL ğŸ”
        uses: github/codeql-action/init@v1
        with:
          languages: javascript,typescript

      # BÆ°á»›c 10: Perform CodeQL Analysis ğŸ“ˆ
      - name: Perform CodeQL Analysis ğŸ•µï¸
        uses: github/codeql-action/analyze@v1